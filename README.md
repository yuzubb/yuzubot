# Chatwork 部屋監視ボット

このボットは、Chatworkの特定の部屋を監視し、指定された条件に基づいてユーザーの権限を自動的に「閲覧のみ」に変更します。また、管理者がコマンドで監視対象の部屋を動的に設定・解除できます。

---

## 機能

このボットには以下の機能が含まれています：

* **スタンプ・絵文字の多投監視**: ユーザーが指定された回数（デフォルト30回）以上のスタンプや顔文字を投稿した場合、そのユーザーの権限を閲覧のみに変更します。
* **`[toall]` の悪用監視**: 管理者以外のメンバーが `[toall]` を使用した場合、そのメンバーの権限を閲覧のみに変更します。管理者が使用した場合は反応しません。
* **個人メンションの多用監視**: ユーザーが指定された回数（デフォルト10回）以上の個人メンション（`[To:アカウントID]`）を投稿した場合、そのユーザーの権限を閲覧のみに変更します。このルールは管理者にも適用されます。
* **部屋ごとの有効化/無効化**:
    * 管理者が部屋で `/command OK` と入力すると、その部屋でのボットの監視を有効化します。ボットは「追加しました」と返信します。
    * 管理者が部屋で `/command NO` と入力すると、その部屋でのボットの監視を無効化します。ボットは「削除しました」と返信します。
* **Supabaseによる設定永続化**: `/command OK` や `/command NO` で設定された監視対象の部屋情報は、Supabaseデータベースに保存され、ボットが再起動しても設定が維持されます。
* **高速ポーリング**: Chatwork APIのレートリミットを考慮しつつ、可能な限り素早い反応（デフォルト5秒間隔）を目指してメッセージを監視します。
* **カウントのリセット**: スタンプ・絵文字、メンションのカウントは、指定された時間（デフォルト24時間）ごとに自動でリセットされます。

---

## デプロイ方法

このボットは、GitHubリポジトリとRender、Supabaseを組み合わせて簡単にデプロイできます。

### 1. Supabaseの準備

1.  **Supabaseアカウントの作成**: Supabaseのウェブサイト ([https://supabase.com/](https://supabase.com/)) でプロジェクトを作成します。
2.  **テーブルの作成**: ボットが監視対象の部屋IDを保存するために、データベースに新しいテーブルを作成します。
    * 左側のナビゲーションで「**Table Editor**」を選択します。
    * 「**New Table**」をクリックします。
    * **Name**: `roomid`
    * **Columns**:
        * `id`: デフォルトの `uuid` または `bigint` (Primary Key, Nullable: オフ)
        * `room_id_column`: `text` または `varchar` (Nullable: オフ, Unique: オン)
    * `Enable Row Level Security (RLS)` は**オフ**のままにしてください。
    * 「Save」をクリックしてテーブルを作成します。
3.  **APIキーの取得**:
    * Supabaseダッシュボードで「**Settings**」→「**API**」に移動します。
    * `Project URL` と `Project API keys` の `service_role` キー (`_key` で終わるもの) を控えておきます。これらは後でRenderの環境変数に設定します。

### 2. GitHubリポジトリの準備

1.  新しいGitHubリポジトリを作成します。
2.  以下の2つのファイルをリポジトリのルートに作成し、コードをコミット＆プッシュします。

    * `main.py` (ボットのメインコード)
    * `requirements.txt` (必要なPythonライブラリ)

    **`requirements.txt` の内容:**

    ```
    requests
    supabase
    ```

    **`main.py` の内容:**
    （以前の応答で提供された**完全なPythonコード**をここにコピー＆ペーストしてください。）

### 3. Chatwork APIトークンの取得

1.  Chatworkにログインし、APIトークン発行ページにアクセスします。
2.  新しいAPIトークンを発行します。**このトークンには、ボットを動作させたいチャットルームに対する「管理者」権限が必要です。**
3.  発行されたAPIトークンを控えておきます。

### 4. Renderへのデプロイ

1.  Renderアカウントにログインします ([https://render.com/](https://render.com/))。
2.  ダッシュボードで「**New**」→「**Background Worker**」を選択します（ボットは常に稼働させるため）。
3.  「**Connect a Git repository**」で、準備したGitHubリポジトリを選択し、接続します。
4.  以下のデプロイ設定を構成します：
    * **Name**: ボットの名前（例: `chatwork-moderation-bot`）
    * **Region**: 最も近いリージョンを選択（例: `Tokyo`）
    * **Branch**: `main` またはあなたがコードをプッシュしたブランチ
    * **Root Directory**: 空欄のまま（リポジトリのルートがプロジェクトのルートの場合）
    * **Runtime**: `Python 3`
    * **Build Command**: `pip install -r requirements.txt`
    * **Start Command**: `python main.py`
5.  **環境変数の設定**: `Advanced` セクションの `Environment Variables` に、以下の変数を追加します。**これらの値はコードに直接記述せず、必ず環境変数で設定してください。**

    * `CHATWORK_API_TOKEN`: あなたのChatwork APIトークン
    * `MONITORED_ROOM_IDS`: ボットが初期に監視を開始するルームID（例: `"1234567,8901234"`）。コンマ区切りで複数指定できます。
    * `STAMP_EMOJI_THRESHOLD`: スタンプ・絵文字の閾値（例: `30`）
    * `MENTION_THRESHOLD`: 個人メンションの閾値（例: `10`）
    * `COUNT_RESET_INTERVAL_HOURS`: カウントをリセットする間隔（時間単位、例: `24`）
    * `POLLING_INTERVAL_SECONDS`: Chatwork APIのポーリング間隔（秒単位、例: `5`）
    * `SUPABASE_URL`: 取得したSupabaseのプロジェクトURL
    * `SUPABASE_KEY`: 取得したSupabaseの **`service_role` キー**

6.  「**Create Web Service**」（または `Create Background Worker`）をクリックしてデプロイを開始します。

デプロイが完了すると、ボットは自動的に起動し、設定されたルームでの監視を開始します。Renderのログを確認して、ボットが正常に動作しているか確認してください。

---

## 使い方

ボットがChatworkの部屋に招待され、デプロイが完了していることを確認してください。

* **監視の有効化**:
    管理者がボットを監視したい部屋で以下のコマンドを投稿します。
    ```
    /command OK
    ```
    ボットはその部屋の監視を開始し、その情報がSupabaseに保存されます。
* **監視の無効化**:
    管理者が監視を止めたい部屋で以下のコマンドを投稿します。
    ```
    /command NO
    ```
    ボットはその部屋での監視を停止し、その情報がSupabaseから削除されます。
* **自動権限変更**:
    * 有効化された部屋で、ユーザーがスタンプ・絵文字または個人メンションの閾値を超えて投稿した場合、そのユーザーの権限は自動的に「閲覧のみ」に変更されます。
    * メンバーが `[toall]` を使用した場合も同様に権限が変更されます。

---

## 注意事項

* **APIトークンの管理**: Chatwork APIトークンおよびSupabaseのService Role Keyは非常に機密性の高い情報です。絶対に公開された場所にハードコードせず、Renderの環境変数で安全に管理してください。
* **権限変更の影響**: ユーザーの権限を自動的に変更する機能は影響が大きいため、事前に十分にテストを行い、意図しない変更が発生しないように注意してください。可能であれば、テスト用のChatworkルームで動作確認を行ってください。
* **レートリミット**: Chatwork APIにはレートリミット（利用制限）があります。ポーリング間隔を短くしすぎるとAPIアクセスが制限される可能性があるため、`POLLING_INTERVAL_SECONDS` の値を適切に設定してください。

---
